#!/usr/bin/env bash
# Configure Nginx to run as nginx user and listen on port 8080

# Ensure nginx user exists
if ! id "nginx" &>/dev/null; then
    adduser --system --no-create-home --disabled-login --disabled-password --group nginx
fi

# Change nginx user in nginx.conf
sed -i 's/#user www-data/user nginx/' /etc/nginx/nginx.conf

# Modify nginx.conf to listen on port 8080
sed -i 's/80/8080/g' /etc/nginx/sites-available/default

# Ensure nginx can read its configuration files
chown -R nginx:nginx /var/log/nginx
chown -R nginx:nginx /var/lib/nginx
chmod 644 /etc/nginx/nginx.conf

# Stop any running nginx processes
pkill nginx

# Start nginx service as nginx user
sudo -u nginx service nginx start

# Verify nginx is running as nginx user
ps auxff |pgrep ngin[x]

# Check if port 8080 is open
nc -z 0 8080 ; echo $?
